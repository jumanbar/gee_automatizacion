library(tidyverse)
param <- read_csv("C:/Users/juan.barreneche/Downloads/parametros_DatosContinuos.csv",
col_types = cols(activo = col_integer()))
cambios <- read_delim("C:/Users/juan.barreneche/Downloads/cambio de contratos R(1).txt",
delim = "\t", escape_double = FALSE,
locale = locale(encoding = "ISO-8859-1"),
trim_ws = TRUE)
cambios
d <- cambios %>%
left_join(param, by = c("param" = "nombre"))
d$linf %>% unique()
d$lsup %>% unique()
dfinal <- d %>%
filter(!is.na(lsup)) %>%
mutate(linf = if_else(linf == "Sin límite", "NULL", linf),
lsup = if_else(lsup == "Sin límite", "NULL", lsup),
SQL = case_when(
linf == "OK" ~ paste0("UPDATE contrato_parametros_rel SET limite_sup = ", lsup, " WHERE id_contrato = ", id_contrato, " AND id_parametro = ", id, ";"),
lsup == "OK" ~ paste0("UPDATE contrato_parametros_rel SET limite_inf = ", linf, " WHERE id_contrato = ", id_contrato, " AND id_parametro = ", id, ";"),
TRUE ~ paste0("UPDATE contrato_parametros_rel SET limite_inf = ", linf, ", limite_sup = ", lsup, " WHERE id_contrato = ", id_contrato, " AND id_parametro = ", id, ";")
))
cat(dfinal$SQL, sep = "\n")
cat(dfinal$SQL, sep = "\n", file = "C:/Users/juan.barreneche/Dropbox/DINACEA/SQL/UPDATEs_LimitesContratosParam_20240712b.sql")
library(readr)
d <- read_delim("updates/pedidos_csv/7 ZONAS_PARA CORREGIR BASE DE DATOS_JULIO 2024.txt",
delim = "\t", escape_double = FALSE,
col_types = cols(...6 = col_skip(), ...7 = col_skip(),
...8 = col_skip(), ...9 = col_skip(),
...10 = col_skip(), ...11 = col_skip()),
trim_ws = TRUE)
View(d)
d <-
read_delim(
"updates/pedidos_csv/7 ZONAS_PARA CORREGIR BASE DE DATOS_JULIO 2024.txt",
delim = "\t",
escape_double = FALSE,
trim_ws = TRUE
)
d
select(-starts_with("..."))
select(d, -starts_with("..."))
d <-
read_delim(
"updates/pedidos_csv/7 ZONAS_PARA CORREGIR BASE DE DATOS_JULIO 2024.txt",
delim = "\t",
escape_double = FALSE,
trim_ws = TRUE
) %>%
select(-starts_with("..."))
makeUpdate <- function(time_start, id_zona, percentil, valor) {
paste0("UPDATE 7_zonas SET valor = ", valor,
" WHERE time_start = '", time_start,
"' AND id_zona = ", id_zona,
" AND percentil = ", percentil,
" AND id_parametro = 2000;")
}
date()
Sys.date()
Sys.Date()
gsub("-", "", Sys.Date())
cat(sep = "\n", file = paste0("UPDATEs_7zonas_", gsub("-", "", Sys.Date())
dfinal %>%
pull(SQL) %>%
cat(sep = "\n", file = paste0("UPDATEs_7zonas_", gsub("-", "", Sys.Date())))
dfinal <- d %>%
pivot_longer(cols = c(p10, p50, p90), names_to = "percentil", values_to = "valor") %>%
mutate(percentil = sub("p", "", percentil),
SQL = makeUpdate(time_start, id_zona, percentil, valor))
dfinal %>%
pull(SQL) %>%
cat(sep = "\n", file = paste0("UPDATEs_7zonas_", gsub("-", "", Sys.Date())))
dfinal %>%
pull(SQL) %>%
cat(sep = "\n", file = paste0("updates/SQL/UPDATEs_7zonas_", gsub("-", "", Sys.Date()), ".sql"))
